#!/usr/bin/env bash
set -euo pipefail

TARGET="${1:-https://proud-ground-0ba6dc70f.1.azurestaticapps.net/}"
HOST=$(python3 -c "import sys,urllib.parse; print(urllib.parse.urlparse(sys.argv[1]).netloc)" "$TARGET")

TS=$(date -u +%Y%m%dT%H%M%SZ)
OUT_RAW="reports/raw/${TS}"
mkdir -p "$OUT_RAW"

# Safety controls
RATE_SLEEP=0.5  # ~2 rps
PAR=5
UA="SyndicateSelfPentest/1.0 (owner-authorized)"

log(){ echo "[$(date -u +%H:%M:%S)] $*"; }

log "Target: $TARGET"
log "Host: $HOST"

# 1) Basic reachability and headers
log "Collecting headers..."
curl -sS -A "$UA" -D "$OUT_RAW/headers.txt" -o "$OUT_RAW/body.html" "$TARGET" || true
curl -sS -A "$UA" -o "$OUT_RAW/index_head.txt" -I "$TARGET" || true

# 2) Fetch a few common paths
log "Fetching common paths (robots.txt, sitemap.xml, manifest)..."
for p in robots.txt sitemap.xml site.webmanifest favicon.ico favicon-32x32.png favicon-16x16.png; do
  curl -sS -A "$UA" -D "$OUT_RAW/${p}.headers" -o "$OUT_RAW/${p}.body" "$TARGET$p" || true
  sleep "$RATE_SLEEP"
done

# 3) API allowlist tests (adjust paths if your proxy differs)
log "API allowlist checks..."
API_BASE="${TARGET}api/panw-status/"
{
  echo "# API allowlist checks";
  echo "GET ${API_BASE}summary";
  curl -sS -A "$UA" -D - "${API_BASE}summary" | head -c 4000; echo;
  sleep "$RATE_SLEEP";

  echo "\nGET ${API_BASE}does-not-exist";
  curl -sS -A "$UA" -D - "${API_BASE}does-not-exist" | head -c 2000; echo;
  sleep "$RATE_SLEEP";

  echo "\nPOST ${API_BASE}summary";
  curl -sS -A "$UA" -X POST -D - "${API_BASE}summary" | head -c 2000; echo;
  sleep "$RATE_SLEEP";

  echo "\nPath traversal attempt ${API_BASE}../../etc/passwd";
  curl -sS -A "$UA" -D - "${API_BASE}../../etc/passwd" | head -c 2000; echo;
  sleep "$RATE_SLEEP";
} > "$OUT_RAW/api_allowlist_checks.txt" || true

# 4) TLS scan (testssl.sh via docker)
log "Running TLS scan (testssl.sh)..."
if command -v docker >/dev/null 2>&1 && docker ps >/dev/null 2>&1; then
    docker run --rm -i drwetter/testssl.sh --quiet --warnings off "$HOST" > "$OUT_RAW/testssl.txt" 2>&1 || true
else
    log "Docker not available or not running. Skipping testssl.sh scan."
    echo "Docker not available. Skipped." > "$OUT_RAW/testssl.txt"
fi

# 5) Nikto (low-risk web server checks)
log "Running Nikto scan (low-risk)..."
if command -v docker >/dev/null 2>&1 && docker ps >/dev/null 2>&1; then
    docker run --rm sullo/nikto -h "$TARGET" -maxtime 10m -nointeractive > "$OUT_RAW/nikto.txt" 2>&1 || true
else
    log "Docker not available or not running. Skipping Nikto scan."
    echo "Docker not available. Skipped." > "$OUT_RAW/nikto.txt"
fi

# 6) OWASP ZAP baseline (passive scan only)
log "Running OWASP ZAP baseline (passive)..."
# ZAP baseline spider is limited; keep it safe and short
mkdir -p "$OUT_RAW/zap"
if command -v docker >/dev/null 2>&1 && docker ps >/dev/null 2>&1; then
    docker run --rm -t -v "$(pwd)/$OUT_RAW/zap:/zap/wrk" owasp/zap2docker-stable zap-baseline.py \
      -t "$TARGET" \
      -r zap_baseline_report.html \
      -J zap_baseline_report.json \
      -w zap_warnings.md \
      -m 5 \
      -a \
      -d \
      -z "-config scanner.attackOnStart=false" \
      || true
else
    log "Docker not available or not running. Skipping OWASP ZAP scan."
    echo "{}" > "$OUT_RAW/zap/zap_baseline_report.json"
    echo "Docker not available. Skipped." > "$OUT_RAW/zap/zap_baseline_report.html"
fi

log "Completed. Raw artifacts in $OUT_RAW"
echo "$OUT_RAW" > reports/raw/LATEST_RUN_PATH.txt
